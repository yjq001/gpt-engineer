<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPT Engineer - 代码生成器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 20px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #f1f3f5;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
        }
        .chat-container {
            height: 300px;
            overflow-y: auto;
            padding: 15px;
            background-color: #fff;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .file-list {
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            background-color: #fff;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .file-item {
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .file-item:hover {
            background-color: #f1f3f5;
        }
        .file-item.active {
            background-color: #e9ecef;
            font-weight: 500;
        }
        .code-editor {
            height: 500px;
            overflow-y: auto;
            padding: 15px;
            background-color: #fff;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            font-family: 'Courier New', Courier, monospace;
        }
        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        .user-message {
            background-color: #d1ecf1;
            margin-left: 20%;
            margin-right: 5px;
        }
        .system-message {
            background-color: #f8d7da;
            margin-right: 20%;
            margin-left: 5px;
        }
        .status-message {
            background-color: #fff3cd;
            text-align: center;
            margin: 5px 10%;
        }
        .warning-message {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            margin: 5px 10%;
        }
        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .btn-primary:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
        }
        pre {
            margin: 0;
            white-space: pre-wrap;
        }
        .hljs {
            background: transparent;
            padding: 0;
        }
        .spinner-border {
            width: 1rem;
            height: 1rem;
            margin-right: 5px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">GPT Engineer - 代码生成器</h1>
        
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">项目信息</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="project-id" class="form-label">项目ID</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="project-id" placeholder="输入项目ID">
                                <button class="btn btn-primary" id="connect-btn">连接</button>
                            </div>
                        </div>
                        <div id="connection-status" class="alert alert-secondary">未连接</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">文件列表</div>
                    <div class="card-body p-0">
                        <div class="file-list" id="file-list">
                            <div class="p-3 text-center text-muted">未连接或无文件</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">聊天</div>
                    <div class="card-body">
                        <div class="chat-container" id="chat-container"></div>
                        <div class="mt-3">
                            <div class="input-group">
                                <textarea class="form-control" id="chat-input" rows="3" placeholder="描述你想要生成的代码..."></textarea>
                                <button class="btn btn-primary" id="send-btn">
                                    <span id="send-spinner" class="spinner-border spinner-border-sm hidden" role="status" aria-hidden="true"></span>
                                    发送
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">代码查看器</div>
                    <div class="card-body p-0">
                        <div class="code-editor" id="code-editor">
                            <div class="p-3 text-center text-muted">请选择文件查看代码</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/java.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/csharp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/cpp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/go.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/ruby.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/php.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/typescript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/html.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/css.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/json.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/xml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/markdown.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/bash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/shell.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/sql.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 元素引用
            const projectIdInput = document.getElementById('project-id');
            const connectBtn = document.getElementById('connect-btn');
            const connectionStatus = document.getElementById('connection-status');
            const fileList = document.getElementById('file-list');
            const chatContainer = document.getElementById('chat-container');
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            const sendSpinner = document.getElementById('send-spinner');
            const codeEditor = document.getElementById('code-editor');
            
            // WebSocket连接
            let socket = null;
            let currentProjectId = null;
            let activeFile = null;
            
            // 生成随机项目ID
            projectIdInput.value = 'project-' + Math.random().toString(36).substring(2, 10);
            
            // 连接WebSocket
            connectBtn.addEventListener('click', function() {
                const projectId = projectIdInput.value.trim();
                if (!projectId) {
                    alert('请输入项目ID');
                    return;
                }
                
                // 断开现有连接
                if (socket) {
                    socket.close();
                    socket = null;
                }
                
                // 更新状态
                connectionStatus.className = 'alert alert-warning';
                connectionStatus.textContent = '正在连接...';
                
                // 创建新连接
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/${projectId}`;
                socket = new WebSocket(wsUrl);
                
                // 连接事件处理
                socket.onopen = function() {
                    connectionStatus.className = 'alert alert-success';
                    connectionStatus.textContent = '已连接';
                    currentProjectId = projectId;
                    addMessage('系统', '连接已建立，你可以开始聊天了。', 'status-message');
                };
                
                socket.onclose = function() {
                    connectionStatus.className = 'alert alert-secondary';
                    connectionStatus.textContent = '未连接';
                    addMessage('系统', '连接已断开。', 'status-message');
                };
                
                socket.onerror = function(error) {
                    connectionStatus.className = 'alert alert-danger';
                    connectionStatus.textContent = '连接错误';
                    console.error('WebSocket错误:', error);
                    addMessage('系统', '连接发生错误。', 'status-message');
                };
                
                socket.onmessage = function(event) {
                    handleMessage(event.data);
                };
            });
            
            // 发送消息
            sendBtn.addEventListener('click', function() {
                sendMessage();
            });
            
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            function sendMessage() {
                if (!socket || socket.readyState !== WebSocket.OPEN) {
                    alert('未连接到服务器');
                    return;
                }
                
                const message = chatInput.value.trim();
                if (!message) {
                    alert('请输入消息');
                    return;
                }
                
                // 发送消息
                const data = {
                    type: 'chat',
                    content: message
                };
                socket.send(JSON.stringify(data));
                
                // 显示消息
                addMessage('用户', message, 'user-message');
                
                // 清空输入框
                chatInput.value = '';
                
                // 显示加载状态
                sendBtn.disabled = true;
                sendSpinner.classList.remove('hidden');
            }
            
            // 处理接收到的消息
            function handleMessage(data) {
                try {
                    const message = JSON.parse(data);
                    console.log('收到消息:', message);
                    
                    switch (message.type) {
                        case 'status':
                            addMessage('系统', message.message, 'status-message');
                            if (message.status === 'processing') {
                                // 显示处理中状态
                                sendBtn.disabled = true;
                                sendSpinner.classList.remove('hidden');
                            }
                            break;
                            
                        case 'warning':
                            // 处理警告消息
                            addMessage('系统', message.message, 'warning-message');
                            break;
                            
                        case 'project_info':
                            // 更新文件列表
                            updateFileList(message.files || []);
                            addMessage('系统', `项目信息已加载，共 ${message.files ? message.files.length : 0} 个文件。`, 'status-message');
                            break;
                            
                        case 'code_generated':
                            // 代码生成完成
                            sendBtn.disabled = false;
                            sendSpinner.classList.add('hidden');
                            
                            // 更新文件列表
                            const files = message.files.map(file => file.path);
                            updateFileList(files);
                            
                            // 存储文件内容
                            message.files.forEach(file => {
                                storeFileContent(file.path, file.content);
                            });
                            
                            addMessage('系统', `代码生成完成，共 ${message.files.length} 个文件。`, 'status-message');
                            break;
                            
                        case 'file_content':
                            // 显示文件内容
                            displayFileContent(message.path, message.content);
                            break;
                            
                        case 'error':
                            // 显示错误消息
                            addMessage('系统', `错误: ${message.message}`, 'system-message');
                            sendBtn.disabled = false;
                            sendSpinner.classList.add('hidden');
                            break;
                            
                        default:
                            console.warn('未知消息类型:', message.type);
                    }
                } catch (e) {
                    console.error('解析消息错误:', e);
                }
            }
            
            // 添加消息到聊天窗口
            function addMessage(sender, content, className) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${className}`;
                
                const senderSpan = document.createElement('div');
                senderSpan.className = 'fw-bold';
                senderSpan.textContent = sender;
                
                const contentDiv = document.createElement('div');
                contentDiv.textContent = content;
                
                messageDiv.appendChild(senderSpan);
                messageDiv.appendChild(contentDiv);
                chatContainer.appendChild(messageDiv);
                
                // 滚动到底部
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            // 更新文件列表
            function updateFileList(files) {
                fileList.innerHTML = '';
                
                if (files.length === 0) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'p-3 text-center text-muted';
                    emptyDiv.textContent = '无文件';
                    fileList.appendChild(emptyDiv);
                    return;
                }
                
                // 按文件类型和名称排序
                files.sort();
                
                files.forEach(file => {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'file-item';
                    fileDiv.textContent = file;
                    fileDiv.dataset.path = file;
                    
                    fileDiv.addEventListener('click', function() {
                        // 移除其他文件的活动状态
                        document.querySelectorAll('.file-item.active').forEach(item => {
                            item.classList.remove('active');
                        });
                        
                        // 添加活动状态
                        fileDiv.classList.add('active');
                        activeFile = file;
                        
                        // 获取文件内容
                        const cachedContent = getFileContent(file);
                        if (cachedContent) {
                            displayFileContent(file, cachedContent);
                        } else if (socket && socket.readyState === WebSocket.OPEN) {
                            socket.send(JSON.stringify({
                                type: 'get_file',
                                path: file
                            }));
                        }
                    });
                    
                    fileList.appendChild(fileDiv);
                });
            }
            
            // 文件内容缓存
            const fileContents = {};
            
            // 存储文件内容
            function storeFileContent(path, content) {
                fileContents[path] = content;
            }
            
            // 获取文件内容
            function getFileContent(path) {
                return fileContents[path];
            }
            
            // 显示文件内容
            function displayFileContent(path, content) {
                // 存储内容到缓存
                storeFileContent(path, content);
                
                // 确定语言
                let language = '';
                if (path.endsWith('.js')) language = 'javascript';
                else if (path.endsWith('.py')) language = 'python';
                else if (path.endsWith('.java')) language = 'java';
                else if (path.endsWith('.cs')) language = 'csharp';
                else if (path.endsWith('.cpp') || path.endsWith('.c') || path.endsWith('.h')) language = 'cpp';
                else if (path.endsWith('.go')) language = 'go';
                else if (path.endsWith('.rb')) language = 'ruby';
                else if (path.endsWith('.php')) language = 'php';
                else if (path.endsWith('.ts')) language = 'typescript';
                else if (path.endsWith('.html')) language = 'html';
                else if (path.endsWith('.css')) language = 'css';
                else if (path.endsWith('.json')) language = 'json';
                else if (path.endsWith('.xml')) language = 'xml';
                else if (path.endsWith('.yaml') || path.endsWith('.yml')) language = 'yaml';
                else if (path.endsWith('.md')) language = 'markdown';
                else if (path.endsWith('.sh') || path.endsWith('.bash')) language = 'bash';
                else if (path.endsWith('.sql')) language = 'sql';
                
                // 创建代码元素
                const pre = document.createElement('pre');
                const code = document.createElement('code');
                if (language) {
                    code.className = `language-${language}`;
                }
                code.textContent = content;
                pre.appendChild(code);
                
                // 清空并添加新内容
                codeEditor.innerHTML = '';
                codeEditor.appendChild(pre);
                
                // 高亮代码
                if (language) {
                    hljs.highlightElement(code);
                }
            }
            
            // 自动连接
            connectBtn.click();
        });
    </script>
</body>
</html> 
