<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API 测试中心</title>
    <!-- Google 登录 API -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        .panel {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background-color: #f9f9f9;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #333;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .output {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            background-color: #fff;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
        }
        .status {
            margin-top: 10px;
            font-weight: bold;
        }
        .connected {
            color: #27ae60;
        }
        .disconnected {
            color: #e74c3c;
        }
        .api-description {
            background-color: #eaf2f8;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        .api-description h3 {
            margin-top: 0;
            color: #2980b9;
        }
        .api-description p {
            margin-bottom: 10px;
        }
        .api-description code {
            background-color: #f7f9fa;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
            border: 1px solid #ddd;
        }
        .api-description ul {
            margin-top: 10px;
            padding-left: 20px;
        }
        .api-description li {
            margin-bottom: 5px;
        }
        .file-list-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .file-list-item:last-child {
            border-bottom: none;
        }
        .loading {
            position: relative;
            color: #666;
        }
        .loading:after {
            content: '...';
            position: absolute;
            animation: dots 1.5s steps(4, end) infinite;
            display: inline-block;
            width: 20px;
            text-align: left;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-connected {
            background-color: #27ae60;
        }
        .status-disconnected {
            background-color: #e74c3c;
        }
        .status-error {
            background-color: #f1c40f;
        }
        .info-message {
            color: #333;
            font-style: italic;
        }
        .success-message {
            color: #27ae60;
            font-weight: bold;
        }
        .warning-message {
            color: #e74c3c;
            font-weight: bold;
        }
        .generation-progress {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f4fd;
            border: 1px solid #b8daff;
            border-radius: 4px;
        }
        .progress-bar {
            height: 4px;
            background-color: #e9ecef;
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
        }
        .step-container {
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .step-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        .status-running {
            background-color: #fff3cd;
            color: #856404;
        }
        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .step-content {
            font-family: monospace;
            white-space: pre-wrap;
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
        }
        .diff-added {
            background-color: #e6ffe6;
            color: #28a745;
        }
        .diff-removed {
            background-color: #ffe6e6;
            color: #dc3545;
        }
    </style>
</head>
<body>
    <h1>API 测试中心</h1>
    
    <div class="tabs">
        <div class="tab active" data-tab="code-generator">代码生成器</div>
        <div class="tab" data-tab="proxy">API 代理</div>
        <div class="tab" data-tab="auth">Google 登录</div>
        <div class="tab" data-tab="rest">REST API</div>
        <div class="tab" data-tab="websocket">WebSocket</div>
    </div>
    
    <div class="container">
        <!-- 代码生成器 -->
        <div class="tab-content active" id="code-generator-content">
            <div class="panel">
                <div class="api-description">
                    <h3>代码生成器</h3>
                    <p>使用AI根据自然语言描述生成代码。只需描述你想要的功能，AI将为你生成完整的代码实现。</p>
                    <p><strong>功能：</strong></p>
                    <ul>
                        <li>支持多种编程语言</li>
                        <li>实时代码生成</li>
                        <li>自动代码格式化</li>
                        <li>支持项目上下文</li>
                    </ul>
                </div>
                
                <div class="form-group">
                    <label for="project-id">项目ID:</label>
                    <input type="text" id="project-id" placeholder="输入项目ID">
                    <button id="connect-btn" style="margin-top: 10px;">连接</button>
                </div>

                <div class="form-group">
                    <label for="file-list">
                        <span class="status-indicator" id="connection-status"></span>
                        文件列表:
                    </label>
                    <div id="file-list" class="output" style="min-height: 100px;">等待连接...</div>
                </div>

                <div class="form-group">
                    <label for="prompt-input">代码生成提示:</label>
                    <textarea id="prompt-input" rows="5" placeholder="描述你想要生成的代码功能..."></textarea>
                </div>
                
                <div class="form-group">
                    <button id="generate-btn">生成代码</button>
                </div>

                <div class="generation-progress" style="display: none;">
                    <h3>生成进度</h3>
                    <div class="progress-bar">
                        <div id="progressBarFill" class="progress-bar-fill" style="width: 0%"></div>
                    </div>
                    <div id="generationSteps"></div>
                </div>

                <div class="form-group">
                    <label for="code-output">生成结果:</label>
                    <div class="output" id="code-output">等待生成...</div>
                </div>

                <div class="file-changes">
                    <h3>文件变更</h3>
                    <div id="fileChangesList"></div>
                </div>

                <div class="form-group">
                    <label for="project-status">项目状态:</label>
                    <div id="project-status" class="info-message">等待连接...</div>
                </div>
            </div>
        </div>

        <!-- API 代理测试 -->
        <div class="tab-content" id="proxy-content">
            <div class="panel">
                <div class="api-description">
                    <h3>API 代理接口</h3>
                    <p>此接口用于解决跨域问题，可以代理转发 HTTP/HTTPS 请求到任意目标 URL。</p>
                    <p><strong>端点：</strong> <code>/api/proxy/forward</code></p>
                    <p><strong>支持方法：</strong> GET, POST, PUT, DELETE, PATCH, HEAD, OPTIONS</p>
                    <p><strong>参数：</strong></p>
                    <ul>
                        <li><code>url</code>: 要转发的 URL (需要进行 URL 编码)</li>
                        <li><code>method</code>: 请求方法 (默认为 GET)</li>
                        <li>其他参数将作为查询参数传递给目标 URL</li>
                    </ul>
                    <p><strong>特性：</strong></p>
                    <ul>
                        <li>自动禁用 SSL 证书验证</li>
                        <li>保留原始请求头和请求体</li>
                        <li>支持所有 HTTP 方法</li>
                    </ul>
                </div>
                
                <div class="form-group">
                    <label for="proxy-url">目标 URL:</label>
                    <input type="text" id="proxy-url" placeholder="https://api.example.com/data" value="https://api.github.com/users/octocat">
                </div>
                
                <div class="form-group">
                    <label for="proxy-method">请求方法:</label>
                    <select id="proxy-method">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                        <option value="PATCH">PATCH</option>
                        <option value="HEAD">HEAD</option>
                        <option value="OPTIONS">OPTIONS</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="proxy-mode">代理模式:</label>
                    <select id="proxy-mode">
                        <option value="normal">标准模式</option>
                        <option value="direct">直接模式 (绕过中间件)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="proxy-params">额外参数 (JSON 格式):</label>
                    <textarea id="proxy-params" rows="3" placeholder='{"param1": "value1", "param2": "value2"}' value='{}'></textarea>
                </div>
                
                <div class="form-group">
                    <label for="proxy-body">请求体 (用于 POST/PUT/PATCH):</label>
                    <textarea id="proxy-body" rows="5" placeholder='{"key": "value"}'></textarea>
                </div>
                
                <div class="form-group">
                    <button id="proxy-send">发送请求</button>
                </div>
                
                <div class="form-group">
                    <label for="proxy-output">响应:</label>
                    <div class="output" id="proxy-output">等待请求...</div>
                </div>
            </div>
        </div>
        
        <!-- Google 登录测试 -->
        <div class="tab-content" id="auth-content">
            <div class="panel">
                <div class="api-description">
                    <h3>Google 登录接口</h3>
                    <p>此接口用于处理 Google OAuth 登录认证。</p>
                    <p><strong>端点：</strong> <code>/api/auth/google</code></p>
                    <p><strong>方法：</strong> POST</p>
                    <p><strong>请求体：</strong></p>
                    <ul>
                        <li><code>idToken</code>: Google 认证返回的 ID 令牌</li>
                    </ul>
                    <p><strong>响应：</strong></p>
                    <ul>
                        <li>用户信息和 JWT 访问令牌</li>
                    </ul>
                    <p><strong>特性：</strong></p>
                    <ul>
                        <li>验证 Google ID 令牌</li>
                        <li>自动创建或更新用户信息</li>
                        <li>生成 JWT 访问令牌</li>
                    </ul>
                </div>
                
                <div id="google-login-container">
                    <div class="form-group">
                        <h4>使用 Google 账号登录</h4>
                        <p>点击下方按钮使用 Google 账号登录：</p>
                        <div id="google-signin-button"></div>
                    </div>
                    
                    <div class="form-group" id="manual-token-input" style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 20px;">
                        <h4>手动输入令牌</h4>
                        <p>如果您已有 Google ID 令牌，可以在下方输入：</p>
                        <label for="auth-token">Google ID 令牌:</label>
                        <input type="text" id="auth-token" placeholder="输入 Google ID 令牌" value="test-token">
                    </div>
                    
                    <div class="form-group">
                        <button id="auth-login">使用令牌登录</button>
                    </div>
                </div>
                
                <div id="user-info-container" style="display: none;">
                    <div class="form-group">
                        <h4>用户信息</h4>
                        <div class="user-profile">
                            <div class="user-avatar">
                                <img id="user-avatar" src="" alt="用户头像" style="width: 80px; height: 80px; border-radius: 50%;">
                            </div>
                            <div class="user-details" style="margin-top: 10px;">
                                <p><strong>名称:</strong> <span id="user-name"></span></p>
                                <p><strong>邮箱:</strong> <span id="user-email"></span></p>
                                <p><strong>ID:</strong> <span id="user-id"></span></p>
                            </div>
                        </div>
                        <button id="auth-logout" style="margin-top: 15px; background-color: #e74c3c;">退出登录</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="auth-output">响应:</label>
                    <div class="output" id="auth-output">等待请求...</div>
                </div>
            </div>
        </div>
        
        <!-- REST API 测试 -->
        <div class="tab-content" id="rest-content">
            <div class="panel">
                <div class="api-description">
                    <h3>REST API 接口</h3>
                    <p>测试各种 REST API 端点。</p>
                    <p><strong>可用端点：</strong></p>
                    <ul>
                        <li><code>/api/users/{id}</code>: 获取用户信息</li>
                        <li><code>/api/projects</code>: 创建项目</li>
                        <li><code>/api/projects/{id}</code>: 获取项目信息</li>
                        <li><code>/api/status/db</code>: 获取数据库连接池状态</li>
                        <li><code>/api/project/{project_id}</code>: 获取项目信息</li>
                        <li><code>/api/project/{project_id}/files</code>: 获取项目文件列表</li>
                        <li><code>/api/project/{project_id}/file</code>: 获取文件内容</li>
                        <li><code>/api/project/{project_id}/file_update</code>: 更新文件内容</li>
                        <li><code>/api/project/{project_id}/file_delete</code>: 删除文件</li>
                        <li><code>/api/project/list</code>: 获取项目列表</li>
                        <li><code>/api/project/public/recent</code>: 获取最近公开项目</li>
                        <li><code>/api/project/{project_id}/collaborate</code>: 申请项目协作</li>
                        <li><code>/api/project/collaborations</code>: 获取协作申请记录</li>
                        <li><code>/api/project/collaborations/{collaboration_id}/handle</code>: 处理协作申请</li>
                        <li><code>/api/project/{project_id}/like</code>: 项目点赞</li>
                        <li><code>/api/order/webhook</code>: Stripe支付回调处理</li>
                        <li><code>/api/order/list</code>: 获取用户订单列表</li>
                        <li><code>/api/order/{order_id}</code>: 获取订单详情</li>
                    </ul>
                </div>
                
                <div class="form-group">
                    <label for="rest-endpoint">端点:</label>
                    <select id="rest-endpoint">
                        <option value="/api/users/{id}">GET /api/users/{id} (获取用户)</option>
                        <option value="/api/projects">POST /api/projects (创建项目)</option>
                        <option value="/api/projects/{id}">GET /api/projects/{id} (获取项目)</option>
                        <option value="/api/status/db">GET /api/status/db (数据库状态)</option>
                        <option value="/api/project/{project_id}">GET /api/project/{project_id} (获取项目信息)</option>
                        <option value="/api/project/{project_id}/files">GET /api/project/{project_id}/files (获取项目文件列表)</option>
                        <option value="/api/project/{project_id}/file">GET /api/project/{project_id}/file?file_path=xxx (获取文件内容)</option>
                        <option value="/api/project/{project_id}/file_update">POST /api/project/{project_id}/file?file_path=xxx (更新文件内容)</option>
                        <option value="/api/project/{project_id}/file_delete">DELETE /api/project/{project_id}/file?file_path=xxx (删除文件)</option>
                        <option value="/api/project/list">GET /api/project/list (获取项目列表)</option>
                        <option value="/api/project/public/recent">GET /api/project/public/recent (获取最近公开项目)</option>
                        <option value="/api/project/{project_id}/collaborate">POST /api/project/{project_id}/collaborate (申请项目协作)</option>
                        <option value="/api/project/collaborations">GET /api/project/collaborations?user_id=xxx&record_type=xxx (获取协作申请记录)</option>
                        <option value="/api/project/collaborations/{collaboration_id}/handle">POST /api/project/collaborations/{collaboration_id}/handle (处理协作申请)</option>
                        <option value="/api/project/{project_id}/like">POST /api/project/{project_id}/like?user_id=xxx (项目点赞)</option>
                        <option value="/api/order/webhook">POST /api/order/webhook (Stripe支付回调处理)</option>
                        <option value="/api/order/list">GET /api/order/list?user_id=xxx (获取用户订单列表)</option>
                        <option value="/api/order/{order_id}">GET /api/order/{order_id}?user_id=xxx (获取订单详情)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="rest-params">参数:</label>
                    <textarea id="rest-params" rows="5" placeholder='{"id": "user-id-here"}'></textarea>
                </div>
                
                <div class="form-group">
                    <button id="rest-send">发送请求</button>
                </div>
                
                <div class="form-group">
                    <label for="rest-output">响应:</label>
                    <div class="output" id="rest-output">等待请求...</div>
                </div>
            </div>
        </div>
        
        <!-- WebSocket 测试 -->
        <div class="tab-content" id="websocket-content">
            <div class="panel">
                <div class="api-description">
                    <h3>WebSocket 接口</h3>
                    <p>测试 WebSocket 连接和消息发送。</p>
                    <p><strong>端点：</strong> <code>ws://{host}/ws/{project_id}</code></p>
                    <p><strong>功能：</strong></p>
                    <ul>
                        <li>实时接收项目生成进度</li>
                        <li>发送控制命令</li>
                    </ul>
                </div>
                
                <div class="api-description">
                    <h4>WebSocket消息格式</h4>
                    <p><strong>从客户端发送到服务器：</strong></p>
                    <ul>
                        <li><code>{"type": "chat", "content": "提示文本", "use_clarify": true}</code> - 发送生成代码的请求。<code>use_clarify</code>参数控制是否启用需求澄清（可选，默认为true）</li>
                        <li><code>{"type": "clarify_response", "content": "用户回答"}</code> - 回复AI的澄清问题</li>
                        <li><code>{"type": "get_file", "path": "文件路径"}</code> - 请求获取特定文件的内容</li>
                    </ul>
                    
                    <p><strong>从服务器发送到客户端：</strong></p>
                    <ul>
                        <li><strong>连接响应：</strong>
                            <ul>
                                <li><code>{"type": "status", "status": "connected", "message": "WebSocket connection established"}</code> - 连接建立</li>
                                <li><code>{"type": "project_info", "project_id": "项目ID", "files": ["文件1", "文件2"...], "is_existing_project": true/false}</code> - 项目信息</li>
                            </ul>
                        </li>
                        <li><strong>AI状态：</strong>
                            <ul>
                                <li><code>{"type": "ai_ready", "model": "模型名称", "project_id": "项目ID"}</code> - AI模型已准备就绪</li>
                            </ul>
                        </li>
                        <li><strong>状态消息：</strong>
                            <ul>
                                <li><code>{"type": "status", "status": "clarifying", "message": "正在澄清需求..."}</code> - 状态更新，状态可以是：clarifying/processing/improving/generating/completed</li>
                                <li><code>{"type": "error", "message": "错误描述"}</code> - 错误信息</li>
                                <li><code>{"type": "warning", "message": "警告信息"}</code> - 警告信息</li>
                            </ul>
                        </li>
                        <li><strong>需求澄清：</strong>
                            <ul>
                                <li><code>{"type": "clarify_start", "message": "开始需求澄清对话，AI将询问一些问题以确保理解您的需求。"}</code> - 澄清开始</li>
                                <li><code>{"type": "clarify_info", "message": "信息描述"}</code> - 澄清过程中的信息</li>
                                <li><code>{"type": "clarify_question", "message": "AI提出的问题"}</code> - AI提出的澄清问题</li>
                                <li><code>{"type": "clarify_assumptions", "message": "AI做出的假设"}</code> - AI做出的假设</li>
                                <li><code>{"type": "clarify_complete", "message": "澄清完成信息"}</code> - 澄清完成</li>
                            </ul>
                        </li>
                        <li><strong>生成进度：</strong>
                            <ul>
                                <li><code>{"type": "step", "step": "步骤名称", "message": "步骤描述", "status": "running/completed/error"}</code> - 代码生成步骤</li>
                                <li><code>{"type": "progress", "progress": 50}</code> - 进度更新（0-100的整数）</li>
                                <li><code>{"type": "stream", "content": "生成的内容片段", "done": false/true}</code> - 流式输出</li>
                            </ul>
                        </li>
                        <li><strong>文件操作：</strong>
                            <ul>
                                <li><code>{"type": "file_added", "file_path": "文件路径", "content": "文件内容"}</code> - 文件添加</li>
                                <li><code>{"type": "file_modified", "file_path": "文件路径", "diff": "差异内容", "content": "完整内容"}</code> - 文件修改</li>
                                <li><code>{"type": "file_deleted", "file_path": "文件路径"}</code> - 文件删除</li>
                                <li><code>{"type": "file_content", "path": "文件路径", "content": "文件内容"}</code> - 文件内容响应</li>
                            </ul>
                        </li>
                        <li><strong>结果响应：</strong>
                            <ul>
                                <li><code>{"type": "code_generated", "project_id": "项目ID", "files": [{"path": "路径1", "content": "内容1"}...], "is_improved": true/false}</code> - 代码生成完成</li>
                            </ul>
                        </li>
                    </ul>
                </div>
                
                <div class="api-description">
                    <h4>WebSocket通信流程</h4>
                    <p><strong>新项目生成流程：</strong></p>
                    <ol>
                        <li><strong>连接建立</strong>: 客户端连接WebSocket，服务器返回连接状态和项目信息</li>
                        <li><strong>发送生成请求</strong>: 客户端发送包含提示的chat消息</li>
                        <li><strong>需求澄清</strong>: 如果启用澄清，服务器发送澄清问题，客户端回复clarify_response</li>
                        <li><strong>代码生成</strong>: 服务器开始生成代码，发送进度更新(progress)、步骤信息(step)和流式输出(stream)</li>
                        <li><strong>文件操作</strong>: 服务器发送文件添加/修改的通知</li>
                        <li><strong>完成</strong>: 服务器发送status类型消息，表示生成完成</li>
                    </ol>
                    
                    <p><strong>现有项目改进流程：</strong></p>
                    <ol>
                        <li><strong>连接建立</strong>: 客户端连接WebSocket，服务器返回连接状态和现有项目信息(is_existing_project=true)</li>
                        <li><strong>发送改进请求</strong>: 客户端发送包含提示的chat消息</li>
                        <li><strong>代码改进</strong>: 服务器开始改进代码，发送进度更新、步骤信息和文件变更通知</li>
                        <li><strong>完成</strong>: 服务器发送status类型消息，表示改进完成</li>
                    </ol>
                    
                    <p><strong>错误处理：</strong></p>
                    <ul>
                        <li>如果在任何阶段发生错误，服务器会发送带有type="error"的消息</li>
                        <li>客户端应监听错误消息并做相应处理，例如向用户显示错误信息</li>
                        <li>在处理大型项目时，建议实现断线重连机制，以防WebSocket连接中断</li>
                    </ul>
                </div>
                
                <div class="api-description">
                    <h4>代码生成步骤与消息</h4>
                    <p>AI代码生成通常包含以下步骤，前端会收到相应的消息：</p>
                    
                    <table border="1" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                        <tr style="background-color: #f2f2f2;">
                            <th style="padding: 8px; text-align: left;">步骤</th>
                            <th style="padding: 8px; text-align: left;">消息类型</th>
                            <th style="padding: 8px; text-align: left;">说明</th>
                        </tr>
                        <tr>
                            <td style="padding: 8px;">连接初始化</td>
                            <td style="padding: 8px;"><code>status</code> + <code>project_info</code></td>
                            <td style="padding: 8px;">连接建立后，服务器发送连接状态和项目信息</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px;">AI模型准备</td>
                            <td style="padding: 8px;"><code>ai_ready</code></td>
                            <td style="padding: 8px;">AI模型已加载并准备就绪</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px;">需求澄清</td>
                            <td style="padding: 8px;"><code>clarify_start</code> → <code>clarify_question</code> → <code>clarify_complete</code></td>
                            <td style="padding: 8px;">AI与用户交互，澄清项目需求（可选步骤）</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px;">代码生成</td>
                            <td style="padding: 8px;"><code>status</code> + <code>step</code> + <code>progress</code> + <code>stream</code></td>
                            <td style="padding: 8px;">AI开始生成代码，发送进度和流式输出</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px;">文件处理</td>
                            <td style="padding: 8px;"><code>file_added</code> / <code>file_modified</code> / <code>file_deleted</code></td>
                            <td style="padding: 8px;">服务器创建/修改/删除文件并发送通知</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px;">生成完成</td>
                            <td style="padding: 8px;"><code>status</code>（status=completed）</td>
                            <td style="padding: 8px;">代码生成过程完成</td>
                        </tr>
                    </table>
                    
                    <p><strong>进度处理说明：</strong></p>
                    <ol>
                        <li>服务器会定期发送<code>progress</code>消息，包含0-100之间的整数值</li>
                        <li>进度为0表示刚开始，100表示完成</li>
                        <li>进度值可能不会线性增长，取决于操作复杂性</li>
                        <li>前端应显示进度条或其他视觉反馈，帮助用户了解生成状态</li>
                    </ol>
                    
                    <p><strong>实现建议：</strong></p>
                    <ul>
                        <li>在开始时重置UI状态（进度条、文件列表等）</li>
                        <li>对于流式输出，累积内容并实时显示，提供打字机效果</li>
                        <li>文件变更通知可用于构建或更新项目文件树</li>
                        <li>添加超时处理和断线重连机制</li>
                        <li>对于较大的文件，可以分块接收并显示，避免UI阻塞</li>
                    </ul>
                </div>
                
                <div class="form-group">
                    <label for="ws-project-id">项目 ID:</label>
                    <input type="text" id="ws-project-id" value="test-project">
                </div>
                
                <div class="form-group">
                    <label for="ws-message">消息:</label>
                    <input type="text" id="ws-message" placeholder="输入消息...">
                </div>
                
                <div class="form-group">
                    <button id="ws-connect">连接</button>
                    <button id="ws-send" disabled>发送</button>
                    <button id="ws-disconnect" disabled>断开</button>
                </div>
                
                <div class="status disconnected" id="ws-status">未连接</div>
                
                <div class="form-group">
                    <label for="ws-output">输出:</label>
                    <div class="output" id="ws-output"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 标签切换功能
        function switchTab(tabId) {
            // 移除所有活动标签和内容
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // 激活当前标签和内容
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`${tabId}-content`).classList.add('active');
        }

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                switchTab(tab.getAttribute('data-tab'));
            });
        });

        // 初始化显示代码生成器标签页
        document.addEventListener('DOMContentLoaded', () => {
            switchTab('code-generator');
            updateConnectionStatus('disconnected');
        });

        // 更新连接状态
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connection-status');
            statusElement.className = 'status-indicator ' + status;
            
            switch(status) {
                case 'connected':
                    statusElement.title = '已连接';
                    break;
                case 'disconnected':
                    statusElement.title = '未连接';
                    document.getElementById('project-status').innerHTML = 
                        '<div class="info-message">等待连接...</div>';
                    break;
                case 'error':
                    statusElement.title = '连接错误';
                    document.getElementById('project-status').innerHTML = 
                        '<div class="warning-message">连接发生错误</div>';
                    break;
                default:
                    statusElement.title = '未知状态';
            }
        }

        // 格式化文件列表显示
        function formatFileList(files) {
            if (!Array.isArray(files) || files.length === 0) {
                return '暂无文件';
            }
            return files.map(file => 
                `<div class="file-list-item">${file}</div>`
            ).join('');
        }

        // WebSocket 连接函数
        function createWebSocket(projectId) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            return new WebSocket(`${protocol}//${window.location.host}/ws/${projectId}`);
        }

        // 代码生成器相关的WebSocket连接
        let codeGenSocket = null;

        // 连接按钮点击事件
        document.getElementById('connect-btn').addEventListener('click', () => {
            const projectId = document.getElementById('project-id').value;
            if (!projectId) {
                alert('请输入项目ID');
                return;
            }

            // 关闭现有连接
            if (codeGenSocket) {
                codeGenSocket.close();
            }

            try {
                // 创建新的WebSocket连接
                codeGenSocket = createWebSocket(projectId);
                
                codeGenSocket.onopen = () => {
                    updateConnectionStatus('connected');
                    document.getElementById('file-list').innerHTML = 
                        '<div class="loading">正在获取文件列表</div>';
                    // 不需要显式请求文件列表，服务器会在连接时自动发送
                    // 之前的代码使用了不支持的消息类型
                    /*
                    codeGenSocket.send(JSON.stringify({
                        type: "get_files"
                    }));
                    */
                };

                codeGenSocket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('收到WebSocket消息:', data);
                        
                        switch(data.type) {
                            case 'project_info':
                                // 处理项目信息，包括文件列表
                                if (data.files && Array.isArray(data.files)) {
                                    document.getElementById('file-list').innerHTML = 
                                        formatFileList(data.files);
                                    
                                    // 根据is_existing_project显示不同的提示
                                    if (data.is_existing_project) {
                                        document.getElementById('project-status').innerHTML = 
                                            '<div class="info-message">已连接到现有项目，可以发送提示来改进代码</div>';
                                    } else {
                                        document.getElementById('project-status').innerHTML = 
                                            '<div class="info-message">已连接到新项目，可以发送提示来生成代码</div>';
                                    }
                                } else {
                                    document.getElementById('file-list').textContent = '暂无文件';
                                    document.getElementById('project-status').innerHTML = 
                                        '<div class="info-message">已连接到新项目，可以发送提示来生成代码</div>';
                                }
                                break;
                            case 'stream':
                            case 'step':
                                updateGenerationProgress(event.data);
                                break;
                            case 'error':
                                document.getElementById('code-output').innerHTML = 
                                    `<div class="error-message">${data.message}</div>`;
                                break;
                            case 'file_added':
                            case 'file_modified':
                            case 'file_deleted':
                                updateFileChanges(event.data);
                                break;
                            case 'status':
                                if (data.status === 'completed') {
                                    document.getElementById('code-output').innerHTML = 
                                        '<div class="success-message">代码生成完成</div>';
                                }
                                break;
                            default:
                                console.log('收到未知类型的消息:', data);
                        }
                    } catch (e) {
                        console.error('解析WebSocket消息失败:', e);
                        document.getElementById('code-output').textContent = 
                            '处理消息时发生错误: ' + e.message;
                        updateConnectionStatus('error');
                    }
                };

                codeGenSocket.onclose = (event) => {
                    updateConnectionStatus('disconnected');
                    document.getElementById('file-list').textContent = '连接已断开';
                    document.getElementById('code-output').textContent = '等待生成...';
                    document.getElementById('project-status').innerHTML = 
                        '<div class="info-message">连接已断开</div>';
                    console.log('WebSocket连接已关闭:', event.code, event.reason);
                };

                codeGenSocket.onerror = (error) => {
                    console.error('WebSocket错误:', error);
                    updateConnectionStatus('error');
                    document.getElementById('file-list').textContent = '连接错误';
                    document.getElementById('project-status').innerHTML = 
                        '<div class="warning-message">连接发生错误，请检查服务器状态</div>';
                    alert('连接发生错误，请检查服务器状态');
                };
            } catch (e) {
                console.error('创建WebSocket连接失败:', e);
                updateConnectionStatus('error');
                alert('创建连接失败: ' + e.message);
            }
        });
        
        // 生成代码按钮点击事件
        document.getElementById('generate-btn').addEventListener('click', () => {
            if (!codeGenSocket || codeGenSocket.readyState !== WebSocket.OPEN) {
                alert('请先连接到项目');
                return;
            }

            const prompt = document.getElementById('prompt-input').value;
            if (!prompt) {
                alert('请输入代码生成提示');
                return;
            }

            document.getElementById('code-output').innerHTML = 
                '<div class="loading">正在生成代码</div>';
            
            // 使用正确的消息类型 "chat" 而不是 "generate_code"
            codeGenSocket.send(JSON.stringify({
                type: "chat",
                content: prompt
            }));
        });
        
        // API 代理测试
        document.getElementById('proxy-send').addEventListener('click', async function() {
            const url = document.getElementById('proxy-url').value;
            const method = document.getElementById('proxy-method').value;
            const paramsInput = document.getElementById('proxy-params').value;
            const bodyInput = document.getElementById('proxy-body').value;
            const outputDiv = document.getElementById('proxy-output');
            
            // 验证 URL
            if (!url) {
                alert('请输入有效的 URL');
                return;
            }
            
            try {
                // 解析额外参数
                const extraParams = paramsInput ? JSON.parse(paramsInput) : {};
                
                // 构建代理 URL
                const encodedUrl = encodeURIComponent(url);
                const proxyMode = document.getElementById('proxy-mode').value;
                let proxyUrl = proxyMode === 'direct' 
                    ? `/api/proxy/direct?url=${encodedUrl}&method=${method}`
                    : `/api/proxy/forward?url=${encodedUrl}&method=${method}`;
                
                // 添加额外参数
                for (const [key, value] of Object.entries(extraParams)) {
                    proxyUrl += `&${key}=${encodeURIComponent(value)}`;
                }
                
                // 显示加载状态
                outputDiv.textContent = '发送请求中...\n';
                outputDiv.textContent += `请求URL: ${proxyUrl}\n`;
                outputDiv.textContent += `请求方法: ${method}\n`;
                if (bodyInput) {
                    outputDiv.textContent += `请求体: ${bodyInput}\n`;
                }
                outputDiv.textContent += '\n等待响应...\n';
                
                // 准备请求选项
                const options = {
                    method: method === 'GET' || method === 'HEAD' ? 'GET' : 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                // 添加请求体（如果需要）
                if (method !== 'GET' && method !== 'HEAD' && bodyInput) {
                    options.body = bodyInput;
                }
                
                // 发送请求
                try {
                    console.log('发送请求:', proxyUrl, options);
                    const response = await fetch(proxyUrl, options);
                    console.log('收到响应:', response);
                    
                    // 获取响应头
                    const headers = {};
                    response.headers.forEach((value, key) => {
                        headers[key] = value;
                        console.log(`响应头: ${key} = ${value}`);
                    });
                    
                    // 显示响应状态和头
                    outputDiv.textContent = `状态: ${response.status} ${response.statusText}\n\n`;
                    outputDiv.textContent += `响应头:\n${JSON.stringify(headers, null, 2)}\n\n`;
                    
                    // 获取响应体
                    const contentType = response.headers.get('content-type');
                    outputDiv.textContent += `内容类型: ${contentType || '未知'}\n\n`;
                    
                    try {
                        // 根据内容类型处理响应
                        if (contentType && contentType.includes('application/json')) {
                            // JSON 响应
                            console.log('处理JSON响应');
                            const jsonData = await response.json();
                            console.log('JSON数据:', jsonData);
                            outputDiv.textContent += `响应体 (JSON):\n${JSON.stringify(jsonData, null, 2)}`;
                        } else if (contentType && contentType.includes('text/')) {
                            // 文本响应
                            console.log('处理文本响应');
                            const textData = await response.text();
                            console.log('文本数据:', textData);
                            outputDiv.textContent += `响应体 (文本):\n${textData}`;
                        } else {
                            // 尝试作为文本处理
                            console.log('尝试作为文本处理响应');
                            try {
                                const textData = await response.text();
                                console.log('获取到文本:', textData);
                                
                                // 尝试解析为 JSON
                                try {
                                    if (textData && textData.trim().startsWith('{')) {
                                        console.log('尝试解析为JSON');
                                        const jsonData = JSON.parse(textData);
                                        console.log('解析为JSON成功:', jsonData);
                                        outputDiv.textContent += `响应体 (解析为JSON):\n${JSON.stringify(jsonData, null, 2)}`;
                                    } else {
                                        console.log('不是JSON格式，显示为文本');
                                        outputDiv.textContent += `响应体 (文本):\n${textData}`;
                                    }
                                } catch (e) {
                                    console.error('JSON解析失败:', e);
                                    outputDiv.textContent += `响应体 (文本):\n${textData}`;
                                }
                            } catch (e) {
                                // 如果无法作为文本处理，则显示为二进制数据
                                console.error('文本处理失败，尝试作为二进制数据:', e);
                                try {
                                    const blob = await response.blob();
                                    console.log('获取到Blob:', blob);
                                    outputDiv.textContent += `响应体 (二进制数据):\n大小: ${blob.size} 字节\n类型: ${blob.type}`;
                                    
                                    // 如果是图片，尝试显示
                                    if (blob.type.startsWith('image/')) {
                                        const imgUrl = URL.createObjectURL(blob);
                                        outputDiv.innerHTML += `<br><br><img src="${imgUrl}" style="max-width: 100%;">`;
                                    }
                                } catch (blobError) {
                                    console.error('Blob处理失败:', blobError);
                                    outputDiv.textContent += `无法处理响应体: ${blobError.message}`;
                                }
                            }
                        }
                    } catch (error) {
                        console.error('解析响应体时出错:', error);
                        outputDiv.textContent += `解析响应体时出错: ${error.message}\n`;
                        
                        // 尝试获取原始响应
                        try {
                            console.log('尝试获取原始响应作为Blob');
                            const blob = await response.blob();
                            console.log('获取到Blob:', blob);
                            outputDiv.textContent += `响应体 (二进制数据):\n大小: ${blob.size} 字节\n类型: ${blob.type}`;
                        } catch (e) {
                            console.error('Blob处理失败:', e);
                            outputDiv.textContent += `无法获取响应体: ${e.message}`;
                        }
                    }
                } catch (error) {
                    console.error('请求错误:', error);
                    outputDiv.textContent = `请求错误: ${error.message}`;
                }
            } catch (error) {
                outputDiv.textContent = `错误: ${error.message}`;
            }
        });
        
        // Google 登录测试
        document.getElementById('auth-login').addEventListener('click', async function() {
            const token = document.getElementById('auth-token').value;
            const outputDiv = document.getElementById('auth-output');
            
            if (!token) {
                alert('请输入 Google ID 令牌');
                return;
            }
            
            try {
                outputDiv.textContent = '正在登录...';
                
                const response = await fetch('/api/auth/google', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ idToken: token })
                });
                
                const data = await response.json();
                outputDiv.textContent = JSON.stringify(data, null, 2);
                
                // 显示用户信息
                if (data.user) {
                    displayUserInfo(data.user, data.token);
                }
            } catch (error) {
                outputDiv.textContent = `登录失败: ${error.message}`;
            }
        });
        
        // 退出登录
        document.getElementById('auth-logout').addEventListener('click', async function() {
            try {
                // 获取存储的令牌
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    alert('您尚未登录');
                    return;
                }
                
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                document.getElementById('auth-output').textContent = JSON.stringify(data, null, 2);
                
                // 清除本地存储的令牌和用户信息
                localStorage.removeItem('auth_token');
                localStorage.removeItem('user_info');
                
                // 隐藏用户信息，显示登录表单
                document.getElementById('user-info-container').style.display = 'none';
                document.getElementById('google-login-container').style.display = 'block';
                
            } catch (error) {
                document.getElementById('auth-output').textContent = `退出失败: ${error.message}`;
            }
        });
        
        // 显示用户信息
        function displayUserInfo(user, token) {
            // 保存令牌到本地存储
            localStorage.setItem('auth_token', token);
            localStorage.setItem('user_info', JSON.stringify(user));
            
            // 设置用户信息
            document.getElementById('user-name').textContent = user.name || '未知';
            document.getElementById('user-email').textContent = user.email || '未知';
            document.getElementById('user-id').textContent = user.id || '未知';
            
            // 设置头像
            if (user.picture) {
                document.getElementById('user-avatar').src = user.picture;
            } else {
                document.getElementById('user-avatar').src = 'https://via.placeholder.com/80?text=用户';
            }
            
            // 隐藏登录表单，显示用户信息
            document.getElementById('google-login-container').style.display = 'none';
            document.getElementById('user-info-container').style.display = 'block';
        }
        
        // 检查是否已登录
        function checkLoggedIn() {
            const token = localStorage.getItem('auth_token');
            const userInfo = localStorage.getItem('user_info');
            
            if (token && userInfo) {
                try {
                    const user = JSON.parse(userInfo);
                    displayUserInfo(user, token);
                    
                    // 验证令牌有效性
                    fetch('/api/auth/user', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            // 令牌无效，清除本地存储
                            localStorage.removeItem('auth_token');
                            localStorage.removeItem('user_info');
                            document.getElementById('user-info-container').style.display = 'none';
                            document.getElementById('google-login-container').style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('验证令牌失败:', error);
                    });
                } catch (e) {
                    console.error('解析用户信息失败:', e);
                }
            }
        }
        
        // 页面加载时检查登录状态
        document.addEventListener('DOMContentLoaded', function() {
            checkLoggedIn();
            initGoogleSignIn();
        });
        
        // 初始化Google登录
        async function initGoogleSignIn() {
            try {
                // 从后端获取Google客户端ID
                const response = await fetch('/api/auth/google-client-id');
                const data = await response.json();
                const clientId = data.clientId;
                
                if (!clientId) {
                    document.getElementById('google-signin-button').innerHTML = 
                        '<div style="color: #e74c3c; margin: 10px 0;">未配置Google客户端ID。请在服务器端设置GOOGLE_CLIENT_ID环境变量。</div>' +
                        '<div>可以使用下方的手动输入方式测试登录功能。</div>';
                    return;
                }
                
                // 初始化 Google 登录按钮
                if (typeof google !== 'undefined' && google.accounts) {
                    google.accounts.id.initialize({
                        client_id: clientId,
                        callback: handleGoogleSignIn
                    });
                    google.accounts.id.renderButton(
                        document.getElementById('google-signin-button'),
                        { theme: 'outline', size: 'large', width: 250 }
                    );
                } else {
                    // Google API 未加载，显示提示
                    document.getElementById('google-signin-button').innerHTML = 
                        '<div style="color: #e74c3c; margin: 10px 0;">Google 登录 API 未加载。请确保已在页面头部添加 Google API 脚本。</div>' +
                        '<div>可以使用下方的手动输入方式测试登录功能。</div>';
                }
            } catch (error) {
                console.error('获取Google客户端ID失败:', error);
                document.getElementById('google-signin-button').innerHTML = 
                    '<div style="color: #e74c3c; margin: 10px 0;">获取Google客户端ID失败: ' + error.message + '</div>' +
                    '<div>可以使用下方的手动输入方式测试登录功能。</div>';
            }
        }
        
        // 处理 Google 登录回调
        function handleGoogleSignIn(response) {
            const idToken = response.credential;
            document.getElementById('auth-token').value = idToken;
            document.getElementById('auth-login').click();
        }
        
        // REST API 测试
        const restEndpointSelect = document.getElementById('rest-endpoint');
        const restParamsTextarea = document.getElementById('rest-params');
        const restSendBtn = document.getElementById('rest-send');
        const restOutputDiv = document.getElementById('rest-output');
        
        // 设置默认参数值
        restEndpointSelect.addEventListener('change', () => {
            const endpoint = restEndpointSelect.value;
            if (endpoint === '/api/users/{id}') {
                restParamsTextarea.value = JSON.stringify({
                    id: "1"
                }, null, 2);
            } else if (endpoint === '/api/projects') {
                restParamsTextarea.value = JSON.stringify({
                    prompt: "Create a simple hello world app",
                    model: "gpt-4",
                    temperature: 0.1
                }, null, 2);
            } else if (endpoint === '/api/projects/{id}') {
                restParamsTextarea.value = JSON.stringify({
                    id: "project-id-here"
                }, null, 2);
            } else if (endpoint === '/api/status/db') {
                restParamsTextarea.value = '{}';
            } else if (endpoint === '/api/project/{project_id}') {
                restParamsTextarea.value = JSON.stringify({
                    project_id: "test-project"
                }, null, 2);
            } else if (endpoint === '/api/project/{project_id}/files') {
                restParamsTextarea.value = JSON.stringify({
                    project_id: "test-project"
                }, null, 2);
            } else if (endpoint === '/api/project/{project_id}/file') {
                restParamsTextarea.value = JSON.stringify({
                    project_id: "test-project",
                    file_path: "main.py"
                }, null, 2);
            } else if (endpoint === '/api/project/{project_id}/file_update') {
                restParamsTextarea.value = JSON.stringify({
                    project_id: "test-project",
                    file_path: "main.py",
                    content: "print('Hello, World!')"
                }, null, 2);
            } else if (endpoint === '/api/project/{project_id}/file_delete') {
                restParamsTextarea.value = JSON.stringify({
                    project_id: "test-project",
                    file_path: "main.py"
                }, null, 2);
            } else if (endpoint === '/api/project/list') {
                restParamsTextarea.value = JSON.stringify({
                    project_id: "test-project"
                }, null, 2);
            } else if (endpoint === '/api/project/public/recent') {
                restParamsTextarea.value = JSON.stringify({
                    project_id: "test-project"
                }, null, 2);
            } else if (endpoint === '/api/project/{project_id}/collaborate') {
                restParamsTextarea.value = JSON.stringify({
                    project_id: "test-project"
                }, null, 2);
            } else if (endpoint === '/api/project/collaborations') {
                restParamsTextarea.value = JSON.stringify({
                    user_id: "test-user",
                    record_type: "collaboration"
                }, null, 2);
            } else if (endpoint === '/api/project/collaborations/{collaboration_id}/handle') {
                restParamsTextarea.value = JSON.stringify({
                    project_id: "test-project",
                    collaboration_id: "test-collaboration"
                }, null, 2);
            } else if (endpoint === '/api/project/{project_id}/like') {
                restParamsTextarea.value = JSON.stringify({
                    project_id: "test-project",
                    user_id: "test-user"
                }, null, 2);
            } else if (endpoint === '/api/order/webhook') {
                restParamsTextarea.value = JSON.stringify({
                    event: "payment.succeeded",
                    data: {
                        id: "test-order",
                        amount: 1000,
                        currency: "USD"
                    }
                }, null, 2);
            } else if (endpoint === '/api/order/list') {
                restParamsTextarea.value = JSON.stringify({
                    user_id: "test-user"
                }, null, 2);
            } else if (endpoint === '/api/order/{order_id}') {
                restParamsTextarea.value = JSON.stringify({
                    order_id: "test-order"
                }, null, 2);
            }
        });
        
        // 触发 change 事件设置初始值
        restEndpointSelect.dispatchEvent(new Event('change'));
        
        // 发送 REST API 请求
        restSendBtn.addEventListener('click', async () => {
            try {
                const endpoint = restEndpointSelect.value;
                const params = JSON.parse(restParamsTextarea.value);
                
                restOutputDiv.textContent = '发送请求中...';
                
                let url = endpoint;
                let method = 'GET';
                let body = null;
                
                // 替换 URL 中的参数并设置请求方法和请求体
                if (endpoint === '/api/users/{id}') {
                    url = endpoint.replace('{id}', params.id);
                } else if (endpoint === '/api/projects' && !endpoint.includes('{id}')) {
                    method = 'POST';
                    body = JSON.stringify(params);
                } else if (endpoint === '/api/projects/{id}') {
                    url = endpoint.replace('{id}', params.id);
                } else if (endpoint === '/api/project/{project_id}') {
                    url = endpoint.replace('{project_id}', params.project_id);
                } else if (endpoint === '/api/project/{project_id}/files') {
                    url = endpoint.replace('{project_id}', params.project_id);
                } else if (endpoint === '/api/project/{project_id}/file') {
                    url = endpoint.replace('{project_id}', params.project_id) + `?file_path=${encodeURIComponent(params.file_path)}`;
                } else if (endpoint === '/api/project/{project_id}/file_update') {
                    url = endpoint.replace('{project_id}', params.project_id).replace('_update', '') + `?file_path=${encodeURIComponent(params.file_path)}`;
                    method = 'POST';
                    body = JSON.stringify({ content: params.content });
                } else if (endpoint === '/api/project/{project_id}/file_delete') {
                    url = endpoint.replace('{project_id}', params.project_id).replace('_delete', '') + `?file_path=${encodeURIComponent(params.file_path)}`;
                    method = 'DELETE';
                } else if (endpoint === '/api/project/list') {
                    url = endpoint;
                } else if (endpoint === '/api/project/public/recent') {
                    url = endpoint;
                } else if (endpoint === '/api/project/{project_id}/collaborate') {
                    url = endpoint.replace('{project_id}', params.project_id);
                    method = 'POST';
                    body = JSON.stringify(params);
                } else if (endpoint === '/api/project/collaborations') {
                    url = endpoint.replace('{user_id}', params.user_id).replace('{record_type}', params.record_type);
                } else if (endpoint === '/api/project/collaborations/{collaboration_id}/handle') {
                    url = endpoint.replace('{collaboration_id}', params.collaboration_id);
                    method = 'POST';
                    body = JSON.stringify(params);
                } else if (endpoint === '/api/project/{project_id}/like') {
                    url = endpoint.replace('{project_id}', params.project_id);
                    method = 'POST';
                    body = JSON.stringify(params);
                } else if (endpoint === '/api/order/webhook') {
                    url = endpoint;
                } else if (endpoint === '/api/order/list') {
                    url = endpoint.replace('{user_id}', params.user_id);
                } else if (endpoint === '/api/order/{order_id}') {
                    url = endpoint.replace('{order_id}', params.order_id);
                }
                
                // 发送请求
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: body
                });
                
                // 解析响应
                const contentType = response.headers.get('content-type');
                let data;
                
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    data = await response.text();
                }
                
                // 显示响应
                restOutputDiv.textContent = typeof data === 'object' 
                    ? JSON.stringify(data, null, 2) 
                    : data;
            } catch (error) {
                restOutputDiv.textContent = `错误: ${error.message}`;
            }
        });
        
        // WebSocket 测试
        let socket = null;
        const wsProjectIdInput = document.getElementById('ws-project-id');
        const wsMessageInput = document.getElementById('ws-message');
        const wsConnectBtn = document.getElementById('ws-connect');
        const wsSendBtn = document.getElementById('ws-send');
        const wsDisconnectBtn = document.getElementById('ws-disconnect');
        const wsStatusDiv = document.getElementById('ws-status');
        const wsOutputDiv = document.getElementById('ws-output');
        
        // 记录 WebSocket 消息
        function logWsMessage(message) {
            const timestamp = new Date().toLocaleTimeString();
            wsOutputDiv.innerHTML += `[${timestamp}] ${message}\n`;
            wsOutputDiv.scrollTop = wsOutputDiv.scrollHeight;
        }
        
        // 连接 WebSocket
        wsConnectBtn.addEventListener('click', () => {
            const projectId = wsProjectIdInput.value.trim();
            if (!projectId) {
                alert('请输入项目 ID');
                return;
            }
            
            // 关闭现有连接
            if (socket) {
                socket.close();
            }
            
            // 创建新的 WebSocket 连接
            socket = createWebSocket(projectId);
            
            // 连接打开
            socket.addEventListener('open', (event) => {
                wsStatusDiv.textContent = '已连接';
                wsStatusDiv.className = 'status connected';
                wsConnectBtn.disabled = true;
                wsSendBtn.disabled = false;
                wsDisconnectBtn.disabled = false;
                logWsMessage('连接已建立');
            });
            
            // 接收消息
            socket.addEventListener('message', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    logWsMessage(`收到: ${JSON.stringify(data, null, 2)}`);
                } catch (e) {
                    logWsMessage(`收到: ${event.data}`);
                }
            });
            
            // 连接关闭
            socket.addEventListener('close', (event) => {
                wsStatusDiv.textContent = '未连接';
                wsStatusDiv.className = 'status disconnected';
                wsConnectBtn.disabled = false;
                wsSendBtn.disabled = true;
                wsDisconnectBtn.disabled = true;
                logWsMessage('连接已关闭');
            });
            
            // 连接错误
            socket.addEventListener('error', (event) => {
                wsStatusDiv.textContent = '错误';
                wsStatusDiv.className = 'status disconnected';
                logWsMessage('WebSocket 错误');
            });
        });
        
        // 发送 WebSocket 消息
        wsSendBtn.addEventListener('click', () => {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                alert('WebSocket 未连接');
                return;
            }
            
            const message = wsMessageInput.value.trim();
            if (!message) {
                alert('请输入消息');
                return;
            }
            
            try {
                // 尝试解析为 JSON
                const jsonMessage = JSON.parse(message);
                socket.send(JSON.stringify(jsonMessage));
                logWsMessage(`发送: ${JSON.stringify(jsonMessage, null, 2)}`);
            } catch (e) {
                // 作为普通文本发送
                socket.send(message);
                logWsMessage(`发送: ${message}`);
            }
            
            wsMessageInput.value = '';
        });
        
        // 断开 WebSocket 连接
        wsDisconnectBtn.addEventListener('click', () => {
            if (socket) {
                socket.close();
                socket = null;
            }
        });

        // 更新生成进度
        function updateGenerationProgress(message) {
            try {
                const data = JSON.parse(message);
                const progressDiv = document.querySelector('.generation-progress');
                progressDiv.style.display = 'block';
                
                // 处理进度更新
                if (typeof data.progress === 'number') {
                    const progressBarFill = document.getElementById('progressBarFill');
                    progressBarFill.style.width = `${data.progress}%`;
                }

                // 处理步骤更新
                if (data.type === 'step' || data.step) {
                    const stepsContainer = document.getElementById('generationSteps');
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'step-container';
                    
                    const stepName = data.step || data.message || 'Processing';
                    const status = data.error ? 'error' : (data.status === 'completed' ? 'completed' : 'running');
                    
                    stepDiv.innerHTML = `
                        <div class="step-header">
                            <span>${stepName}</span>
                            <span class="step-status status-${status}">${status}</span>
                        </div>
                        <div class="step-content">${data.content || ''}</div>
                    `;
                    stepsContainer.appendChild(stepDiv);
                }

                // 处理流式输出
                if (data.type === 'stream') {
                    const stepsContainer = document.getElementById('generationSteps');
                    let streamDiv = document.getElementById('current-stream');
                    
                    if (!streamDiv) {
                        streamDiv = document.createElement('div');
                        streamDiv.id = 'current-stream';
                        streamDiv.className = 'step-container';
                        streamDiv.innerHTML = `
                            <div class="step-header">
                                <span>AI Output</span>
                                <span class="step-status status-running">streaming</span>
                            </div>
                            <div class="step-content"></div>
                        `;
                        stepsContainer.appendChild(streamDiv);
                    }
                    
                    const content = streamDiv.querySelector('.step-content');
                    if (data.content) {
                        content.textContent += data.content;
                        content.scrollTop = content.scrollHeight;
                    }
                    
                    if (data.done) {
                        const status = streamDiv.querySelector('.step-status');
                        status.className = 'step-status status-completed';
                        status.textContent = 'completed';
                    }
                }
            } catch (e) {
                console.error('Error updating generation progress:', e);
            }
        }

        // 更新文件变更
        function updateFileChanges(message) {
            try {
                const data = JSON.parse(typeof message === 'string' ? message : JSON.stringify(message));
                const fileChangesList = document.getElementById('fileChangesList');
                
                const changeDiv = document.createElement('div');
                changeDiv.className = 'file-change-item';
                
                if (data.type === 'file_added') {
                    changeDiv.innerHTML = `
                        <div><strong>添加文件:</strong> ${data.file_path}</div>
                        <pre><code>${data.content}</code></pre>
                    `;
                } else if (data.type === 'file_modified') {
                    changeDiv.innerHTML = `
                        <div><strong>修改文件:</strong> ${data.file_path}</div>
                        <pre><code>${data.diff || data.content}</code></pre>
                    `;
                } else if (data.type === 'file_deleted') {
                    changeDiv.innerHTML = `
                        <div><strong>删除文件:</strong> ${data.file_path}</div>
                    `;
                }
                
                fileChangesList.appendChild(changeDiv);
            } catch (e) {
                console.error('Error updating file changes:', e);
            }
        }
    </script>
</body>
</html> 
